<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Health Check - Survey Brain</title>
  <style>
    :root {
      --bg: #1a1d24;
      --card: linear-gradient(145deg, #2a2f3a 0%, #363c4a 50%, #2a2f3a 100%);
      --border: #4a5568;
      --accent: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Courier New', 'Consolas', monospace;
      background: var(--bg);
      color: #e2e8f0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 20px;
      text-shadow: 0 0 10px var(--accent);
    }
    .card {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: inset 2px 2px 5px rgba(0,0,0,0.4), inset -2px -2px 5px rgba(255,255,255,0.1);
    }
    button {
      background: linear-gradient(145deg, var(--accent) 0%, #059669 100%);
      border: 2px solid var(--border);
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 700;
      margin-right: 10px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    button:hover {
      background: linear-gradient(145deg, #34d399 0%, var(--accent) 100%);
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }
    button:active {
      transform: translateY(1px);
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .status.ok { background: var(--accent); color: white; }
    .status.degraded { background: var(--warning); color: white; }
    .status.error { background: var(--danger); color: white; }
    .result {
      background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
    }
    pre {
      color: var(--accent);
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 0.85rem;
      line-height: 1.5;
    }
    .info {
      background: rgba(16, 185, 129, 0.1);
      border-left: 3px solid var(--accent);
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: var(--accent);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    input {
      width: 100%;
      background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
      border: 2px solid var(--border);
      color: var(--accent);
      padding: 10px;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.9rem;
      margin-bottom: 15px;
    }
    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
    }
    .test-section {
      margin-top: 30px;
    }
    .test-section h2 {
      color: var(--accent);
      font-size: 1.1rem;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß System Health Check</h1>

    <div class="card">
      <div class="info">
        <strong>Instructions:</strong> Enter your worker URL below and click "Check Health" to diagnose authentication issues.
      </div>

      <label for="workerUrl">Worker URL:</label>
      <input
        type="text"
        id="workerUrl"
        placeholder="https://your-worker.workers.dev"
        value="https://depot-voice-notes.martinbibb.workers.dev"
      />

      <button onclick="checkHealth()">üîç Check Health</button>
      <button onclick="checkDbHealth()">üíæ Check Database</button>
      <button onclick="testLogin()">üîê Test Login</button>
      <button onclick="testRegister()">üìù Test Register</button>
      <button onclick="clearResults()">üóëÔ∏è Clear Results</button>

      <div id="result"></div>
    </div>

    <div class="card test-section">
      <h2>Test Authentication</h2>

      <label for="testEmail">Email:</label>
      <input type="email" id="testEmail" placeholder="test@example.com" />

      <label for="testPassword">Password:</label>
      <input type="password" id="testPassword" placeholder="password123" />

      <label for="testUsername">Username (for registration):</label>
      <input type="text" id="testUsername" placeholder="testuser" />

      <div id="authResult"></div>
    </div>
  </div>

  <script type="module">
    window.checkHealth = async function() {
      const workerUrl = document.getElementById('workerUrl').value.trim();
      const resultDiv = document.getElementById('result');

      if (!workerUrl) {
        resultDiv.innerHTML = '<div class="result"><pre>Please enter a worker URL</pre></div>';
        return;
      }

      resultDiv.innerHTML = '<div class="result"><pre>Checking health...</pre></div>';

      try {
        // Check basic health
        const healthResponse = await fetch(`${workerUrl}/health`);
        const healthData = await healthResponse.json();

        // Check auth health
        const authHealthResponse = await fetch(`${workerUrl}/auth/health`);
        const authHealthData = await authHealthResponse.json();

        const status = authHealthData.status || 'unknown';
        const statusClass = status === 'ok' ? 'ok' : status === 'degraded' ? 'degraded' : 'error';

        let html = `
          <div class="result">
            <h3>üè• Health Check Results</h3>
            <p><strong>Status:</strong> <span class="status ${statusClass}">${status}</span></p>
            <p><strong>Timestamp:</strong> ${authHealthData.timestamp || 'N/A'}</p>

            <h4 style="margin-top: 20px;">üíæ Database</h4>
            <pre>Connected: ${authHealthData.database?.connected ? '‚úÖ Yes' : '‚ùå No'}
Tables Exist: ${authHealthData.database?.tablesExist ? '‚úÖ Yes (3/3)' : '‚ùå No'}
Tables Found: ${authHealthData.database?.tables?.join(', ') || 'None'}
${authHealthData.database?.error ? `Error: ${authHealthData.database.error}` : ''}</pre>

            <h4 style="margin-top: 20px;">üîê JWT Configuration</h4>
            <pre>JWT Secret: ${authHealthData.jwt?.configured ? '‚úÖ Configured' : '‚ùå Not Configured'}</pre>

            ${authHealthData.error ? `<h4 style="margin-top: 20px;">‚ùå Error</h4><pre>${authHealthData.error}</pre>` : ''}

            <h4 style="margin-top: 20px;">üìã Recommendations</h4>
            <pre>${getRecommendations(authHealthData)}</pre>

            <h4 style="margin-top: 20px;">üìÑ Full Response</h4>
            <pre>${JSON.stringify(authHealthData, null, 2)}</pre>
          </div>
        `;

        resultDiv.innerHTML = html;
      } catch (err) {
        resultDiv.innerHTML = `
          <div class="result">
            <h3>‚ùå Connection Error</h3>
            <pre>${err.message}

Possible causes:
1. Worker URL is incorrect
2. Worker is not deployed
3. CORS is blocking the request
4. Network connectivity issues

Try:
- Verify the worker URL
- Deploy with: wrangler deploy
- Check browser console for errors</pre>
          </div>
        `;
      }
    };

    window.checkDbHealth = async function() {
      const workerUrl = document.getElementById('workerUrl').value.trim();
      const resultDiv = document.getElementById('result');

      if (!workerUrl) {
        resultDiv.innerHTML = '<div class="result"><pre>Please enter a worker URL</pre></div>';
        return;
      }

      resultDiv.innerHTML = '<div class="result"><pre>Checking database health...</pre></div>';

      try {
        const dbHealthResponse = await fetch(`${workerUrl}/db/health`);
        const dbHealthData = await dbHealthResponse.json();

        const status = dbHealthData.status || 'unknown';
        const statusClass = status === 'ok' ? 'ok' : status === 'degraded' ? 'degraded' : 'error';

        let html = `
          <div class="result">
            <h3>üíæ Database Health Check Results</h3>
            <p><strong>Status:</strong> <span class="status ${statusClass}">${status}</span></p>
            <p><strong>Timestamp:</strong> ${dbHealthData.timestamp || 'N/A'}</p>

            <h4 style="margin-top: 20px;">üîó Database Connection</h4>
            <pre>Binding Available: ${dbHealthData.database?.binding ? '‚úÖ Yes' : '‚ùå No'}
Connected: ${dbHealthData.database?.connected ? '‚úÖ Yes' : '‚ùå No'}
Query Test: ${dbHealthData.database?.queryTest ? '‚úÖ Passed' : '‚ùå Failed'}</pre>

            <h4 style="margin-top: 20px;">üìä Database Tables</h4>
            <pre>Tables Found: ${dbHealthData.database?.tables?.join(', ') || 'None'}
Expected Tables: ${dbHealthData.database?.expectedTables?.join(', ') || 'N/A'}
Missing Tables: ${dbHealthData.database?.missingTables?.length ? dbHealthData.database.missingTables.join(', ') : 'None'}</pre>

            <h4 style="margin-top: 20px;">üì¶ Storage (R2)</h4>
            <pre>R2 Bucket: ${dbHealthData.storage?.r2Binding ? '‚úÖ Configured' : '‚ö†Ô∏è Not Configured'}
${dbHealthData.storage?.note || ''}</pre>

            ${dbHealthData.errors?.length ? `<h4 style="margin-top: 20px;">‚ùå Errors</h4><pre>${dbHealthData.errors.join('\n')}</pre>` : ''}
            ${dbHealthData.note ? `<h4 style="margin-top: 20px;">‚ÑπÔ∏è Note</h4><pre>${dbHealthData.note}</pre>` : ''}

            <h4 style="margin-top: 20px;">üìã Recommendations</h4>
            <pre>${getDbRecommendations(dbHealthData)}</pre>

            <h4 style="margin-top: 20px;">üìÑ Full Response</h4>
            <pre>${JSON.stringify(dbHealthData, null, 2)}</pre>
          </div>
        `;

        resultDiv.innerHTML = html;
      } catch (err) {
        resultDiv.innerHTML = `
          <div class="result">
            <h3>‚ùå Connection Error</h3>
            <pre>${err.message}

Possible causes:
1. Worker URL is incorrect
2. Worker is not deployed
3. CORS is blocking the request
4. Network connectivity issues

Try:
- Verify the worker URL
- Deploy with: wrangler deploy
- Check browser console for errors</pre>
          </div>
        `;
      }
    };

    window.testLogin = async function() {
      const workerUrl = document.getElementById('workerUrl').value.trim();
      const email = document.getElementById('testEmail').value.trim();
      const password = document.getElementById('testPassword').value;
      const resultDiv = document.getElementById('authResult');

      if (!email || !password) {
        resultDiv.innerHTML = '<div class="result"><pre>Please enter email and password</pre></div>';
        return;
      }

      resultDiv.innerHTML = '<div class="result"><pre>Testing login...</pre></div>';

      try {
        const response = await fetch(`${workerUrl}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();
        const success = response.ok && data.success;

        resultDiv.innerHTML = `
          <div class="result">
            <h3>${success ? '‚úÖ Login Successful' : '‚ùå Login Failed'}</h3>
            <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </div>
        `;
      } catch (err) {
        resultDiv.innerHTML = `
          <div class="result">
            <h3>‚ùå Request Error</h3>
            <pre>${err.message}</pre>
          </div>
        `;
      }
    };

    window.testRegister = async function() {
      const workerUrl = document.getElementById('workerUrl').value.trim();
      const username = document.getElementById('testUsername').value.trim();
      const email = document.getElementById('testEmail').value.trim();
      const password = document.getElementById('testPassword').value;
      const resultDiv = document.getElementById('authResult');

      if (!username || !email || !password) {
        resultDiv.innerHTML = '<div class="result"><pre>Please enter username, email, and password</pre></div>';
        return;
      }

      resultDiv.innerHTML = '<div class="result"><pre>Testing registration...</pre></div>';

      try {
        const response = await fetch(`${workerUrl}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });

        const data = await response.json();
        const success = response.ok && data.success;

        resultDiv.innerHTML = `
          <div class="result">
            <h3>${success ? '‚úÖ Registration Successful' : '‚ùå Registration Failed'}</h3>
            <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </div>
        `;
      } catch (err) {
        resultDiv.innerHTML = `
          <div class="result">
            <h3>‚ùå Request Error</h3>
            <pre>${err.message}</pre>
          </div>
        `;
      }
    };

    window.clearResults = function() {
      document.getElementById('result').innerHTML = '';
      document.getElementById('authResult').innerHTML = '';
    };

    function getRecommendations(health) {
      const recs = [];

      if (!health.database?.connected) {
        recs.push('‚ùå Database not connected - Check D1 binding in wrangler.toml');
      }

      if (!health.database?.tablesExist) {
        recs.push('‚ùå Auth tables missing - Try registering a user to auto-create tables');
      }

      if (!health.jwt?.configured) {
        recs.push('‚ùå JWT secret not set - Run: wrangler secret put JWT_SECRET');
      }

      if (health.status === 'ok') {
        recs.push('‚úÖ All systems operational!');
      }

      return recs.length > 0 ? recs.join('\n') : 'No issues detected';
    }

    function getDbRecommendations(health) {
      const recs = [];

      if (!health.database?.binding) {
        recs.push('‚ùå Database binding missing - Add D1 database binding in wrangler.toml');
      }

      if (!health.database?.connected) {
        recs.push('‚ùå Database not connected - Check if D1 database exists and is properly bound');
      }

      if (health.database?.missingTables?.length > 0) {
        recs.push('‚ö†Ô∏è Some tables are missing - They will be created automatically on first use');
        if (health.database.missingTables.includes('users')) {
          recs.push('   - Register a user to create auth tables');
        }
        if (health.database.missingTables.includes('user_sessions')) {
          recs.push('   - Save a session to create session tables');
        }
        if (health.database.missingTables.includes('reference_materials')) {
          recs.push('   - Add reference materials for the AI agent');
        }
      }

      if (!health.storage?.r2Binding) {
        recs.push('‚ÑπÔ∏è R2 bucket not configured - Optional for storing reference documents');
      }

      if (health.status === 'ok') {
        recs.push('‚úÖ Database is fully accessible and operational!');
      }

      return recs.length > 0 ? recs.join('\n') : 'No issues detected';
    }

    // Auto-check on load
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (!urlParams.has('noauto')) {
        checkHealth();
      }
    });
  </script>
</body>
</html>
