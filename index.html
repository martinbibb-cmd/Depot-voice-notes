<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Depot Dictation Notes (Pro-ready)</title>
<style>
  :root{--bg:#0b0d10;--card:#11151a;--line:#22303d;--txt:#e8eaed}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:var(--card)}
  h1{margin:0;font-size:18px}
  main{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  .section{display:grid;gap:10px}
  .hint{font-size:12px;opacity:.85}
  textarea{width:100%;min-height:120px;background:#0a0e13;border:1px solid var(--line);border-radius:10px;color:var(--txt);padding:10px;font-size:15px;resize:vertical}
  button,input,select{font-size:14px;border-radius:10px;border:1px solid var(--line);background:#0a0e13;color:var(--txt);padding:8px 10px;cursor:pointer}
  .pill{border-radius:999px}
  .copy{border-style:dashed}
  .badge{font-size:12px;border:1px solid var(--line);padding:2px 8px;border-radius:999px}
  .ok{border-color:#2e7d32}
  .warn{border-color:#b28704}
  .label{font-weight:600}
  .small{font-size:12px;opacity:.75}
  .pro{border-color:#2e7d32}
</style>
</head>
<body>
<header>
  <h1>Depot Dictation Notes</h1>
  <div class="row small">
    <span id="license-badge" class="badge">Pro: locked</span>
    <span id="sr-badge" class="badge">Speech: checking‚Ä¶</span>
  </div>
</header>

<main>
  <!-- Pro / License panel -->
  <section class="card">
    <div class="row">
      <button id="enter-code" class="pill">Enter/Refresh Unlock Code</button>
      <button id="clear-code" class="pill">Clear Code</button>
      <span id="license-info" class="small"></span>
    </div>
    <div class="small">
      After payment, you‚Äôll receive a code to paste here. Codes are tied to your email and expire periodically.
    </div>
  </section>

  <!-- Basics -->
  <section class="card">
    <div class="row">
      <span class="label">Customer</span>
      <input id="customer" placeholder="Name / site (optional)" style="min-width:260px"/>
    </div>
    <div class="row">
      <span class="label">Scenario</span>
      <select id="scenario">
        <option>REGULAR (open) ‚Üí COMBI</option>
        <option>REGULAR (sealed) ‚Üí COMBI</option>
        <option>SYSTEM (open cyl) ‚Üí COMBI</option>
        <option>SYSTEM (unvented) ‚Üí COMBI</option>
        <option>COMBI ‚Üí SYSTEM (unvented)</option>
        <option>COMBI ‚Üí REGULAR (sealed)</option>
        <option>Like-for-like</option>
      </select>
      <span class="label">Flue</span>
      <select id="flue"><option>Fanned horizontal</option><option>Vertical</option></select>
      <span class="label">Elevation</span>
      <select id="elevation">
        <option>Rear / clear</option><option>Front elevation</option>
        <option>Close to boundary</option><option>Near doors/windows/path</option>
      </select>
      <button id="copy-all" class="pill copy" disabled>Copy ALL (Pro)</button>
    </div>
    <div class="small">Free: per-section copy & dictation. <b>Pro</b>: ‚ÄúCopy ALL‚Äù + (add your own extras here: longer recording, extra hints, export, etc.).</div>
  </section>

  <div id="sections"></div>
</main>

<script>
/* ====== PRO LICENSE (public-key verify; token in localStorage) ====== */
/*
 Token format (stringified JSON, then Base64URL, then signature Base64URL):
  payload = { email, exp /* ISO datetime */, plan:"pro-v1" }
  signature = Ed25519(payloadBytes)
  code = base64url(payload) + "." + base64url(signature)

 You keep the PRIVATE key offline (see gen_license.mjs). This app embeds only the PUBLIC key and verifies.
*/
const LICENSE_STORAGE_KEY = "depot_license_code";

/* Paste your PUBLIC KEY (from gen_license.mjs output) */
const PUBLIC_KEY_JWK = {
  // Example only; replace with your exported public JWK
  "kty":"OKP",
  "crv":"Ed25519",
  "x":"REPLACE_ME_WITH_BASE64URL_X"
};

function b64uToBytes(s){ s=s.replace(/-/g,'+').replace(/_/g,'/'); const pad = s.length%4?4-(s.length%4):0; return Uint8Array.from(atob(s+"=".repeat(pad)), c=>c.charCodeAt(0)); }
function bytesToB64u(bytes){ const s = btoa(String.fromCharCode(...bytes)); return s.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }

async function importPublicKey(jwk){ return crypto.subtle.importKey("jwk", jwk, {name:"Ed25519", namedCurve:"Ed25519"}, false, ["verify"]); }

async function verifyCode(code){
  try{
    const [p, sig] = code.split(".");
    if(!p || !sig) return { ok:false, reason:"Bad format" };
    const payloadBytes = b64uToBytes(p);
    const sigBytes = b64uToBytes(sig);
    const pub = await importPublicKey(PUBLIC_KEY_JWK);
    const ok = await crypto.subtle.verify("Ed25519", pub, sigBytes, payloadBytes);
    if(!ok) return { ok:false, reason:"Signature check failed" };
    const payload = JSON.parse(new TextDecoder().decode(payloadBytes));
    const exp = Date.parse(payload.exp||"");
    if(!payload.email || !exp || Number.isNaN(exp)) return { ok:false, reason:"Invalid payload" };
    const now = Date.now();
    if(now > exp) return { ok:false, reason:"Expired", payload };
    const daysLeft = Math.ceil((exp - now)/(1000*60*60*24));
    return { ok:true, payload, daysLeft };
  }catch(e){ return { ok:false, reason:e.message }; }
}

function setProUI(valid, info){
  const badge = document.getElementById("license-badge");
  const infoEl = document.getElementById("license-info");
  const copyAll = document.getElementById("copy-all");
  if(valid){
    badge.textContent = "Pro: active"; badge.classList.add("ok"); badge.classList.remove("warn");
    copyAll.disabled = false; copyAll.classList.add("pro");
    infoEl.textContent = `Licensed to ${info.payload.email} ‚Ä¢ expires ${new Date(info.payload.exp).toLocaleDateString()} (${info.daysLeft}d left)`;
    if(info.daysLeft <= 7) infoEl.textContent += " ‚Äî refresh soon";
  }else{
    badge.textContent = "Pro: locked"; badge.classList.add("warn"); badge.classList.remove("ok");
    copyAll.disabled = true; copyAll.classList.remove("pro");
    infoEl.textContent = "Enter unlock code after payment.";
  }
}

async function loadLicense(){
  const code = localStorage.getItem(LICENSE_STORAGE_KEY);
  if(!code) return setProUI(false);
  const res = await verifyCode(code);
  setProUI(res.ok, res);
}
async function promptLicense(){
  const code = prompt("Paste your unlock code:");
  if(!code) return;
  const res = await verifyCode(code.trim());
  if(!res.ok){ alert("Invalid code: "+(res.reason||"unknown")); setProUI(false); return; }
  localStorage.setItem(LICENSE_STORAGE_KEY, code.trim());
  setProUI(true, res);
}
function clearLicense(){ localStorage.removeItem(LICENSE_STORAGE_KEY); setProUI(false); }
document.getElementById("enter-code").onclick = promptLicense;
document.getElementById("clear-code").onclick = clearLicense;

/* ====== App (same core as free) ====== */
const SECTION_DEFS = [
  { id:"Working at heights", hints:[
    "If vertical flue: ladder to roof standard / linking ladders",
    "If scaffold/MEWP needed, note lead time & access",
  ]},
  { id:"Access", hints:[ "Parking, stairs, tight loft hatch, narrow alley" ]},
  { id:"System characteristics", hints:[
    "Describe conversion impact (e.g., F&E removal vented‚Üísealed/combi)",
    "Cylinder removal / unvented install details",
  ]},
  { id:"Mains & DHW", hints:[
    "Confirm mains static/dynamic & flow vs MI",
    "COMBI: one draw-off best; hot not instant at outlet",
    "UNVENTED: G3 pack & D2 safe termination",
  ]},
  { id:"Controls", hints:[ "Programmer/room stat setup; clear CH/DHW schedules", "TRVs / load/comp where applicable" ]},
  { id:"Electrics", hints:[ "Fused spur / supplies / bonding observations (no wiring design)" ]},
  { id:"Gas", hints:[ "Meter location, pipe run considerations (no calcs here)" ]},
  { id:"Water & Condensate", hints:[ "Condensate route & PRV safe termination" ]},
  { id:"Boiler & Location", hints:[ "Proposed location and allowances" ]},
  { id:"Commissioning", hints:[ "Flush/clean, inhibitor, filter, Benchmark & handover" ]},
  { id:"Flue & Terminal", hints:[
    "Horizontal: clearances; guard if <2 m or accessible",
    "Front/boundary: consider plume/deflector",
    "Vertical: roof access verified",
  ]},
  { id:"Pipework", hints:[ "Primaries adaptation; valve/pump config matches hydraulics" ]},
  { id:"Customer impacts", hints:[ "Disruption; making good; space from cylinder removal" ]},
];

const srBadge = document.getElementById("sr-badge");
const sectionsContainer = document.getElementById("sections");
const sectionTextareas = new Map();
const bullet = t => "‚ÜòÔ∏è " + t.replace(/[;]+$/,"") + ";";

function el(tag, attrs={}, kids=[]){
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (k==="class") n.className=v; else if (k==="html") n.innerHTML=v; else n.setAttribute(k,v);
  }
  (Array.isArray(kids)?kids:[kids]).forEach(c=>n.appendChild(typeof c==="string"?document.createTextNode(c):c));
  return n;
}
function renderSections(){
  sectionsContainer.innerHTML = "";
  SECTION_DEFS.forEach(def=>{
    const hints = el("div",{class:"hint"}, def.hints.map(h=>el("div",{}, "‚Ä¢ "+h)));
    const ta = el("textarea",{id:"ta-"+def.id});
    sectionTextareas.set(def.id, ta);
    const rowBtns = el("div",{class:"row"},[
      el("button",{class:"pill", id:"mic-"+def.id}, "üé§ Dictate"),
      el("button",{class:"pill copy", id:"copy-"+def.id}, "Copy section"),
    ]);
    const card = el("section",{class:"card section"},[
      el("div",{class:"label"},def.id),hints,ta,rowBtns
    ]);
    sectionsContainer.appendChild(card);
    rowBtns.querySelector("#copy-"+CSS.escape(def.id)).onclick = ()=>{
      const text = ta.value.trim();
      const ready = text.split(/\n+/).map(s=>s.trim()).filter(Boolean).map(bullet).join(" ");
      copyText(ready);
    };
    rowBtns.querySelector("#mic-"+CSS.escape(def.id)).onclick = ()=>dictateWebSpeech(ta);
  });
}
renderSections();

/* Copy ALL (Pro-gated) */
document.getElementById("copy-all").onclick = ()=>{
  const btn = document.getElementById("copy-all");
  if(btn.disabled){ alert("Copy ALL is a Pro feature. Enter your unlock code."); return; }
  const lines = [];
  SECTION_DEFS.forEach(def=>{
    const t = (sectionTextareas.get(def.id).value||"")
      .split(/\n+/).map(s=>s.trim()).filter(Boolean)
      .map(bullet);
    lines.push(...t);
  });
  copyText(lines.join(" "));
};
function copyText(text){
  const d = document.createElement("textarea");
  d.value = text; document.body.appendChild(d); d.select();
  document.execCommand("copy"); document.body.removeChild(d);
}

/* Nudges (same as free) */
function pushIfEmpty(id, txts){ const ta=sectionTextareas.get(id); if(!ta.value.trim()) ta.value = txts.map(bullet).join("\n"); }
["scenario","flue","elevation"].forEach(id=>{
  document.getElementById(id).addEventListener("change", ()=>{
    const scen = document.getElementById("scenario").value;
    const flue = document.getElementById("flue").value;
    const elev = document.getElementById("elevation").value;
    if(/‚Üí COMBI/.test(scen)){
      pushIfEmpty("Mains & DHW",[
        "DHW expectations: single draw-off best; mains-dependent; hot not instant at outlet",
        "Confirm mains static/dynamic pressure & flow meet MI"
      ]);
    }
    if(/REGULAR \(open\) ‚Üí/.test(scen)){
      pushIfEmpty("System characteristics",[ "Vented ‚Üí sealed/combi: remove/abandon F&E; cap/repurpose cold feed & vent" ]);
    }
    if(/UNVENTED/.test(scen)){
      pushIfEmpty("Mains & DHW",[ "Unvented: G3 pack; D2 discharge to safe termination; verify mains suitability" ]);
    }
    if(flue==="Vertical"){
      pushIfEmpty("Flue & Terminal",[ "Vertical balanced flue: verify roof access; add WAH plan as needed" ]);
    } else {
      const extra = (elev!=="Rear / clear")?["Add terminal guard if <2 m or accessible","Consider plume management/deflector near paths, doors, windows, boundary"]:[];
      pushIfEmpty("Flue & Terminal",[ "Horizontal balanced flue: verify clearances to openings and boundary", ...extra ]);
    }
  });
});

/* Web Speech API */
const SRClass = window.SpeechRecognition || window.webkitSpeechRecognition;
let SR = null;
(function initSR(){
  if(SRClass){
    SR = new SRClass();
    SR.lang = "en-GB";
    SR.interimResults = false;
    SR.maxAlternatives = 1;
    srBadge.textContent = "Speech: ready"; srBadge.classList.add("ok");
  }else{
    srBadge.textContent = "Speech: unavailable"; srBadge.classList.add("warn");
  }
})();
function dictateWebSpeech(into){
  return new Promise(resolve=>{
    if(!SR) { alert("Browser speech not available."); return resolve(""); }
    SR.onresult = (e)=>{
      const t = e.results?.[0]?.[0]?.transcript || "";
      into.value = (into.value? into.value+"\n":"") + t.trim();
      resolve(t);
    };
    SR.onerror = ()=>resolve("");
    try{ SR.start(); } catch { resolve(""); }
  });
}

/* Boot */
loadLicense();
</script>
</body>
</html>
